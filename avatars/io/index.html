<!DOCTYPE html>

<html>
<head>
<title>Alles steht Kopf 2</title>
<style>
  body {
    background-color: #1a1a1a;
    color: #f0f0f0;
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
  }
  header {
    background-color: #333;
    padding: 10px;
    text-align: center;
  }
  header img {
    max-height: 100px;
  }
  .gallery {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(184px, 1fr));
    grid-gap: 4px;
    padding: 10px;
  }
  .gallery img {
    max-width: 100%;
    height: auto;
    border: 1px solid #666;
  }
</style>
<script>
// Function to update the user image
async function updateUserImage(imagePath) {
  // Fetch credentials from localStorage
  const jsonCredentials = localStorage.getItem('jellyfin_credentials');

  if (!jsonCredentials) {
    alert('User credentials not found. Please log in again.');
    return;
  }

  const credentials = JSON.parse(jsonCredentials);

  if (!credentials.Servers || credentials.Servers.length === 0) {
    alert('No Jellyfin servers found in localStorage.');
    return;
  }

  const server = credentials.Servers[0];
//old user id format nulled
//  const userId = server.UserId;
  // Get the userId from sessionStorage (previously monitored from URL)
  const userId = sessionStorage.getItem('lsuserid');
  const apiKey = server.AccessToken;
  const serverUrl = server.LocalAddress || server.ManualAddress;

  if (!userId || !apiKey || !serverUrl) {
    console.error('Missing user ID, API key, or server URL.');
    alert('User credentials are incomplete. Please log in again.');
    return;
  }

  // Construct the URL for the API request
  const apiUrl = `${serverUrl}/Users/${userId}/Images/Primary`;

  // Construct the image URL relative to the current page
  const currentPageUrl = window.location.href;
  const baseUrl = currentPageUrl.substring(0, currentPageUrl.lastIndexOf('/') + 1);
  const imageUrl = baseUrl + imagePath;

  try {
    // Fetch the image as a Blob
    const response = await fetch(imageUrl);
    if (!response.ok) {
      throw new Error(`Failed to fetch image: ${response.statusText}`);
    }
    const blob = await response.blob();

    // Convert Blob to Base64 string
    const base64String = await blobToBase64(blob);
    const contentType = blob.type || 'image/jpeg'; // Default to JPEG if type is missing

    // Send the POST request with Base64-encoded image data
    const uploadResponse = await fetch(apiUrl, {
      method: 'POST',
      headers: {
        'Authorization': `MediaBrowser Token="${apiKey}"`,
        'Content-Type': contentType
      },
      body: base64String, // Send as Base64 string
      mode: 'cors'
    });

    if (uploadResponse.ok) {
      const userConfirmed = confirm('User image updated successfully! Do you want to go back to the home page?');
      if (userConfirmed) {
        window.location.href = '/web/#/home.html';
      }
    } else {
      const errorData = await uploadResponse.json().catch(() => null);
      console.error('Server Error Details:', errorData || 'No additional details.');
      throw new Error(`Failed to update user image. Status: ${uploadResponse.status}, Details: ${errorData?.detail || 'Unknown error'}`);
    }
  } catch (error) {
    console.error('Error:', error);
    alert('An error occurred while updating the user image.');
  }
}

// Helper function to convert Blob to Base64 string
function blobToBase64(blob) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onloadend = () => {
      const base64Data = reader.result.split(',')[1]; // Remove the Data URL prefix
      resolve(base64Data);
    };
    reader.onerror = reject;
    reader.readAsDataURL(blob);
  });
}


</script></head>
<body>
<header>
<img alt="Logo" onclick="updateUserImage('logo.png')" src="logo.png" style="cursor: pointer;"/>
</header>
<h1>Alles steht Kopf zwei!</h1>
<div class="gallery">
<img alt="Image" loading="lazy" onclick="updateUserImage('freude.jpg')" src="freude.jpg" style="cursor: pointer;"/>
<img alt="Image" loading="lazy" onclick="updateUserImage('ekel.jpg')" src="ekel.jpg" style="cursor: pointer;"/>
<img alt="Image" loading="lazy" onclick="updateUserImage('enui.jpg')" src="enui.jpg" style="cursor: pointer;"/>
<img alt="Image" loading="lazy" onclick="updateUserImage('angst.jpg')" src="angst.jpg" style="cursor: pointer;"/>
<img alt="Image" loading="lazy" onclick="updateUserImage('kummer.jpg')" src="kummer.jpg" style="cursor: pointer;"/>
<img alt="Image" loading="lazy" onclick="updateUserImage('neid.jpg')" src="neid.jpg" style="cursor: pointer;"/>
<img alt="Image" loading="lazy" onclick="updateUserImage('peinlich.jpg')" src="peinlich.jpg" style="cursor: pointer;"/>
<img alt="Image" loading="lazy" onclick="updateUserImage('wut.jpg')" src="wut.jpg" style="cursor: pointer;"/>
<img alt="Image" loading="lazy" onclick="updateUserImage('zweifel.jpg')" src="zweifel.jpg" style="cursor: pointer;"/>
<img alt="Image" loading="lazy" onclick="updateUserImage('young.png')" src="young.png" style="cursor: pointer;"/>
<img alt="Image" loading="lazy" onclick="updateUserImage('teen.png')" src="teen.png" style="cursor: pointer;"/>
<img alt="Image" loading="lazy" onclick="updateUserImage('bingbong.png')" src="bingbong.png" style="cursor: pointer;"/>
</div></body></html>
